<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>PAPER</title>
    {% include "support/cssjs.html" %}
</head>
<style>
</style>

<body class="navbar-md-md-top">
    {% include "support/navbar.html" %}
    <!-- Page content -->
    <div class="page-content pt-0">
        {% include "support/sidebar.html" %}
        <script type="text/javascript">
            alert("HAII")
            console.log("INI SAYA")
        </script>
        <!-- Main content -->
        <div class="content-wrapper" id="appcontent">

            <!-- Content area -->
            <div class="content">

                <!-- Basic card -->
                <div class="card">
                    <div class="card-header header-elements-inline">
                        <h5 class="card-title">Biaya</b></h5>
                        <div class="header-elements">
                            <div class="list-icons">
                                <a class="list-icons-item" data-action="collapse"></a>
                                <a class="list-icons-item" data-action="reload"></a>
                                <a class="list-icons-item" data-action="remove"></a>
                            </div>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-md-12">
                                <button @click="openModal('add')" type="button" class="btn bg-pink rounded-round"><i
                                        class="icon-add mr-2"></i>
                                    Biaya</button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="table-responsive">


                                    <table class="table table-striped">
                                        <thead class="bg-blue-600">
                                            <th>No.</th>
                                            <th>Kode Biaya</th>
                                            <th>Tanggal</th>
                                            <th>Bulan</th>
                                            <th>Tahun</th>
                                            <th>Jumlah</th>
                                            <th>Keterangan</th>
                                            <th>Action</th>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(v,k) in isitbl">
                                                <th>((k+1))</th>
                                                <th>((v.idbiaya))</th>
                                                <th>((v.tanggal))</th>
                                                <th>((v.bulan))</th>
                                                <th>((v.tahun))</th>
                                                <th>(( formatRupiah(v.jumlah) ))</th>
                                                <th>((v.ket))</th>
                                                <td>
                                                    <div class="list-icons">
                                                        <a @click="openModal(((v.idbiaya)))" href="#"
                                                            class="list-icons-item" data-popup="tooltip" title="Edit"
                                                            data-container="body">
                                                            <i class="icon-pencil7"></i>
                                                        </a>
                                                        <a @click="processDel(((v.idbiaya)))" href="#"
                                                            class="list-icons-item" data-popup="tooltip" title="Remove"
                                                            data-container="body">
                                                            <i class="icon-trash"></i>
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="modalForm" class="modal " tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-primary">
                                    <h6 class="modal-title">((ketAct))</h6>
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                </div>

                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="">Code</label>
                                                <input type="text" class="form-control" v-model="frm1.code">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="">Tanggal</label>
                                                <input type="text" class="form-control datepicker" v-model="frm1.tgl">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="">Jumlah</label>
                                                <input type="text" class="form-control form-control-sm"
                                                    placeholder="ex: 5000" v-model="tmph">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="">Keterangan</label>
                                                <input type="text" class="form-control form-control-sm"
                                                    v-model="frm1.ket">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn bg-primary" v-show="add" @click="btnAddFrm">Add
                                        Data</button>
                                    <button type="button" class="btn bg-warning" v-show="edit" @click="btnEditFrm">Edit
                                        Data</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /basic card -->

            </div>
            <!-- /content area -->

        </div>
        <!-- /main content -->
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script>
        function formatRupiah(angka, prefix) {
            var number_string = angka.toString().replace(/[^,\d]/g, "").toString(),
                split = number_string.split(","),
                sisa = split[0].length % 3,
                rupiah = split[0].substr(0, sisa),
                ribuan = split[0].substr(sisa).match(/\d{3}/gi);
            if (ribuan) {
                separator = sisa ? "." : "";
                rupiah += separator + ribuan.join(".");
            }

            rupiah = split[1] != undefined ? rupiah + "," + split[1] : rupiah;
            return prefix == undefined ? rupiah : rupiah ? "Rp. " + rupiah : "";
        }
        function clearTitik(huruf) {
            return huruf.replace(/[^0-9]/g, "")
        }
        function clearSymbol(huruf) {
            return huruf.replace(/[`~!@#$%^&*()_|+\-=?;:'",.<>\{\}\[\]\\\/]/gi, '')
        }
        let swalInit = swal.mixin({
            buttonsStyling: false,
            confirmButtonClass: 'btn btn-primary',
            cancelButtonClass: 'btn btn-light'
        });
        let appcontent = new Vue({
            el: '#appcontent',
            delimiters: ['((', '))'],
            data: {
                ketAct: 'Add Biaya',
                add: true,
                edit: false,
                isitbl: [],
                frm1: {
                    "tmpcode": '',
                    "code": '',
                    "tgl": '',
                    "ket": '',
                    "jml": '',
                },
                tmph: '',
            },
            mounted() {
                console.log('Run Awal')

                //$.get("getDataGLHeader").done(data => {
                //    this.isicbgl = JSON.parse(data)
                //})
                $.get("getbiaya").done(data => {
                    this.isitbl = JSON.parse(data)
                })
                $("input.datepicker").on("change", (evt) => {
                    this.frm1.tgl = evt.target.value
                })
                $('.datepicker').datepicker({
                    changeMonth: true,
                    changeYear: true,
                    dateFormat: "yymmdd",
                    isRTL: $('html').attr('dir') == 'rtl' ? true : false
                })
                this.frm1.tgl = this.getToday()
            },
            watch: {
                tmph: {
                    handler: function (newValue) {
                        this.frm1.jml = clearTitik(newValue)
                        this.tmph = formatRupiah(newValue)
                    },
                }
            },
            methods: {
                openModal(apa = "add") {
                    if (apa == "add") {
                        //alert(this.isitbl[0].idbiaya.slice(-4))
                        //let newkd = parseInt(this.isitbl[this.isitbl.length - 1].idbiaya.slice(-4)) + 1
                        let newkd = parseInt(this.isitbl[0].idbiaya.slice(-4)) + 1
                        let kd = (newkd.toString().length == 1) ? `000${newkd}` : (newkd.toString().length == 2) ? `00${newkd}` : (newkd.toString().length == 3) ? `0${newkd}` : newkd
                        this.frm1.tmpcode = "00"
                        this.frm1.code = `B${kd}`
                        //this.frm1.tgl = this.frm1.tgl
                        this.frm1.ket = ""
                        this.frm1.jml = ""
                        this.tmph = ""
                        this.ketAct = "Add Biaya";
                        this.btnFrm(true, false)
                    } else {
                        let idx = this.findById(apa, "idbiaya")
                        let jsn = this.isitbl[idx]
                        this.frm1.tmpcode = jsn.idbiaya
                        this.frm1.code = jsn.idbiaya
                        this.frm1.tgl = jsn.tanggal
                        this.frm1.ket = jsn.ket
                        this.frm1.jml = jsn.jumlah
                        this.tmph = formatRupiah(jsn.jumlah)
                        this.ketAct = "Edit Biaya";
                        this.btnFrm(false, true)
                    }
                    $("#modalForm").modal("show")
                },
                btnAddFrm() {
                    if (!this.validasi()) { this.msgFrm("Uppss.!", "Fill All Data Data..!", "error"); return; }
                    $.post("addBiaya", this.frm1).done(data => {
                        $("#modalForm").modal("hide")
                        this.msgFrm("Success.!", "Success Add Data..!", "success")
                        this.isitbl = JSON.parse(data)
                    })
                },
                btnEditFrm() {
                    if (!this.validasi()) { this.msgFrm("Uppss.!", "Fill All Data Data..!", "error"); return; }
                    $.post("editBiaya", this.frm1).done(data => {
                        $("#modalForm").modal("hide")
                        this.msgFrm("Success.!", "Success Edit Data..!", "success")
                        this.isitbl = JSON.parse(data)
                    })
                },
                processDel(idnya = false) {
                    if (idnya !== false) {
                        swalInit({
                            title: 'Are you sure Delete?',
                            text: "You won't be able to revert this!",
                            type: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Yes, delete it!',
                            cancelButtonText: 'No, cancel!',
                            confirmButtonClass: 'btn btn-success',
                            cancelButtonClass: 'btn btn-danger',
                            buttonsStyling: false
                        }).then(result => {
                            if (result.value) {
                                $.post("delBiaya", { "id": idnya }).done(data => {
                                    this.msgFrm("Success.!", "Success Delete Data..!", "success")
                                    this.isitbl = JSON.parse(data)
                                })
                            }
                        });
                    }
                },
                formatRupiah(angka, prefix) {
                    var number_string = angka.toString().replace(/[^,\d]/g, "").toString(),
                        split = number_string.split(","),
                        sisa = split[0].length % 3,
                        rupiah = split[0].substr(0, sisa),
                        ribuan = split[0].substr(sisa).match(/\d{3}/gi);
                    if (ribuan) {
                        separator = sisa ? "." : "";
                        rupiah += separator + ribuan.join(".");
                    }

                    rupiah = split[1] != undefined ? rupiah + "," + split[1] : rupiah;
                    return prefix == undefined ? rupiah : rupiah ? "Rp. " + rupiah : "";
                },
                getToday() {
                    let today = new Date();
                    let dd = today.getDate();
                    let mm = today.getMonth() + 1;

                    let yyyy = today.getFullYear();
                    if (dd < 10) {
                        dd = '0' + dd;
                    }
                    if (mm < 10) {
                        mm = '0' + mm;
                    }
                    today = `${yyyy}${mm}${dd}`;
                    return today
                },
                msgFrm(ttl, txt, typ) {
                    swalInit({
                        title: ttl,
                        text: txt,
                        type: typ
                    });
                },
                btnFrm(b1 = true, b2 = false) {
                    this.add = b1; this.edit = b2;
                },
                findById(tmpid, apa) {
                    let idxToRemove
                    this.isitbl.forEach(function (dt, index) {
                        if (dt[apa] == tmpid) idxToRemove = index;
                    });
                    return idxToRemove
                },
                validasi() {
                    for (var key in this.frm1) {
                        if (this.frm1[key] === '' || this.frm1[key] == '' || this.frm1[key] === null || this.frm1[key] == null) {
                            return false
                        }
                    }
                    return true
                },
            }
        })
    </script>
</body>

</html>